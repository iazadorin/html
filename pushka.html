<!DOCTYPE html>
<html>
<head>
	<title>
		Обнаружение алмаза Монах
	</title>
	<style>
		canvas{
			border: 1px solid black;
		}
	</style>
</head>
<body>
	<canvas id ='canvasElement' width=600 height=600 style='background-color:#79C1BD'>
	</canvas>
	<div style="display: none;">
		<img id = 'plane'
			src = "plane.png"
		/>
	</div>
	<div style="display: none;">
		<img id = 'enemyPlane'
			src = "enemy-plane.png"
		/>
	</div>
	<div style="display: none;">
		<img id = 'enemyTank'
			src = "enemy-tank.png"
		/>
	</div>
	<div style="display: none;">
		<img id = 'fire-small'
			src = "fire-small.png"
		/>
	</div>
	<div style="display: none;">
		<img id = 'fire-medium'
			src = "fire-medium.png"
		/>
	</div>
	<div style="display: none;">
		<img id = 'fire-large'
			src = "fire-large.png"
		/>
	</div>
	<pre id='p' style="font-size:25px"></pre>
	<script>
		var textElement = document.getElementById('p');
		var canvasElement = document.getElementById('canvasElement');
		var canvasContext = canvasElement.getContext('2d');
		var planeImg = document.getElementById('plane');
		var enemyPlaneImg = document.getElementById('enemyPlane');
		var enemyTankImg = document.getElementById('enemyTank');
		var fireImg1 = document.getElementById('fire-small');
		var fireImg2 = document.getElementById('fire-medium');
		var fireImg3 = document.getElementById('fire-large');
		var gameOver = false;
		var score = 0;
		var enemies = [];
		var plane = {
			x: 300,
			y: 540,
			dmgOfRocket: 25,
			dmgOfBullet: 5,
			color: '#FF7E00',
			traceVisible: false,
			numberOfFramesTheTraceIsVisibleYet: 0,
			draw: function(){
				canvasContext.drawImage(planeImg, this.x - planeImg.width/2, this.y - planeImg.height/2);
				if (this.numberOfFramesTheTraceIsVisibleYet < 3){
					if (this.traceVisible){ 
						canvasContext.beginPath();
						canvasContext.moveTo(this.x, this.y - planeImg.height/2);
						canvasContext.lineTo(this.x, 0);
						canvasContext.closePath();
						canvasContext.strokeStyle = this.color;
						canvasContext.stroke();
						this.numberOfFramesTheTraceIsVisibleYet++;
					}
				}
				else {
					this.traceVisible = false;
					this.numberOfFramesTheTraceIsVisibleYet = 0;
				}
			}
		}
		var enemyPlane = {
			v: 2,
			x: 300,
			y: -50,
			hp: 25,
			fireImgNumber: 0,
			frameNumber: 0,
			create: function(){
				this.x = Math.floor(enemyPlaneImg.width/2 + Math.random() * (canvasElement.width - enemyPlaneImg.width));
				this.y = Math.floor(-enemyPlaneImg.height - Math.random() * (canvasElement.height - enemyPlaneImg.height));
				this.hp = 25;
			},
			draw: function(){
				canvasContext.drawImage(enemyPlaneImg, this.x - enemyPlaneImg.width/2, this.y - enemyPlaneImg.height/2);
				if(this.hp <= 0){
					var img;
					if(this.fireImgNumber==0){
						img = fireImg1;
					}
					else if(this.fireImgNumber==1){
						img = fireImg2;
					}
					else{
						img = fireImg3;
					}
					canvasContext.drawImage(img, this.x - img.width/2, this.y - img.height/2);
				}
				
			},
			move: function(){
				var killed = false;
				if(this.hp <= 0){
					this.frameNumber++;
					if(this.frameNumber == 15){
						this.frameNumber = 0;
						this.fireImgNumber++;
						if(this.fireImgNumber > 2){
							killed = true;
						}
					}
				}
				this.y+=this.v;
				if	(this.y > canvasElement.height + enemyPlaneImg.height/2 || killed){
					this.create();
				}
			}
		}
		var enemyTank = {
			v: 1,
			x: 300,
			y: -60,
			hp: 50,
			draw: function(){
				canvasContext.drawImage(enemyTankImg, this.x - enemyTankImg.width/2, this.y - enemyTankImg.height/2);
			},
			move: function(){
				this.y+=this.v;
				if	(this.y > canvasElement.height + enemyTankImg.height/2){
					this.x = Math.floor(enemyTankImg.width/2 + Math.random() * (canvasElement.width - enemyTankImg.width));
					this.y = Math.floor(-enemyTankImg.height - Math.random() * (canvasElement.height - enemyTankImg.height));
				}
			}
		}
		function createEnemies(){
			enemies[0] = Object.assign({}, enemyPlane);
			enemies[1] = Object.assign({}, enemyPlane);
			for (var i = 0; i < enemies.length; i++){
				enemies[i].create();
			}
		}
		function mouseMove(e){
			plane.x = e.offsetX;
			plane.y = e.offsetY;
		}
		function mouseClick(event){
			if (gameOver==true){
				return;
			}
			plane.traceVisible = true;
			for (var i = 0; i < enemies.length; i++){
				if (enemies[i].hp > 0){
					if (plane.y - planeImg.height/2 > enemies[i].y + enemyPlaneImg.height/2 && enemies[i].y > 0){
						if (plane.x > enemies[i].x - enemyPlaneImg.width/2 &&  plane.x < enemies[i].x + enemyPlaneImg.width/2){
							enemies[i].hp -= plane.dmgOfBullet;
							if(enemies[i].hp <= 0){
								score += 200;
								enemies[i].frameNumber = 0;
								enemies[i].fireImgNumber = 0;
							}
						}
					}
				}
			}
		}
		function iteration(){
			canvasContext.clearRect(0,0, canvasElement.width, canvasElement.height);
			enemyTank.move();
			enemyTank.draw();
			for (var i = 0; i < enemies.length; i++){
				enemies[i].draw();
				enemies[i].move();
			}
			plane.draw();
			showScore();
			window.requestAnimationFrame(iteration);
		}
		function showScore(){
			textElement.textContent = 'Твой счёт: '
			textElement.textContent += score;
		}
		createEnemies();
		canvasElement.addEventListener('mousemove', mouseMove);
		canvasElement.addEventListener('click', mouseClick);
		iteration();
	</script>
</body>