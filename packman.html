<!DOCTYPE html>
<html>
<head>
	<title>
		Обнаружение алмаза Монах
	</title>
	<style>
		canvas{
			border: 1px solid black;
		}
	</style>
</head>
<body onload="score()">
	<canvas id ='canvasElement' width=400 height=400 style='background-color:black'>
	</canvas>
	<pre id="p" style="font-size:25px"></pre>
	<script>
		var gameOver = false;
		var gameScore = 0;
		var textElement = document.getElementById('p');
		var canvasElement = document.getElementById('canvasElement');
		var canvasContext = canvasElement.getContext('2d');
		var packMan = {
			n: 0,
			x: 100,
			y: 100,
			vx: 0,
			vy: 0,
			v:4,
			dir: 0,
			radius: 25,
			color: 'Moccasin',
			draw: function() {
				var a = 30;
				if(this.n<10){
					a=1;
				}
				else if(this.n<20){
					a=15;
				}
				else if(this.n<30){
					a=30;
				}
				else if(this.n<40){
					a=45;
				}
				else if(this.n<50){
					a=60;
				}
				else if(this.n<60){
					a=45;
				}
				else if(this.n<70){
					a=30;
				}
				else{
					a=15;
				}
				var ea, sa;
				switch (this.dir){
					case 0:
						sa = a;
						ea = 360 - a;
						break;
					case 1:
						sa = a+270;
						ea = 270 - a;
						break;
					case 2:
						sa = 180 + a;
						ea = 180 - a;
						break;
					default:
						sa = 90 + a;
						ea = 90 - a;
						break;
				}
				var gradient = canvasContext.createLinearGradient(this.x-this.radius,0, this.x+this.radius,0);
				gradient.addColorStop(0, '#FEE068');
				gradient.addColorStop(1, '#9F8D43');
				canvasContext.fillStyle = gradient;
				canvasContext.strokeStyle = '#9F8D43';
				canvasContext.beginPath();
				canvasContext.arc(this.x, this.y, this.radius, Math.PI * sa/180, Math.PI * ea/180);
				canvasContext.lineTo(this.x, this.y);
				canvasContext.closePath();
				canvasContext.fill();
				canvasContext.stroke();
				if(this.vx!=0 || this.vy!=0){
					this.n++;
					if(this.n>=80){
						this.n=0;
					}
				}
			}
		}
		var dot = {
			n:0,
			x:0,
			y:0,
			r:10,
			color:'gold',
			draw: function(){
					var a = 0;
					if(this.n<10){
						a=0;
					}
					else if(this.n<20){
						a=0.5;
					}
					else if(this.n<30){
						a=1;
					}
					else if(this.n<40){
						a=1.5;
					}
					else if(this.n<50){
						a=2;
					}
					else if(this.n<60){
						a=2.5;
					}
					else if(this.n<70){
						a=3;
					}
					else if(this.n<80){
						a=2.5;
					}
					else if(this.n<90){
						a=2;
					}
					else if(this.n<100){
						a=1.5;
					}
					else if(this.n<110){
						a=1;
					}
					else{
						a=0.5;
					}
				var gradient = canvasContext.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.r);
				gradient.addColorStop(0, '#0EC400');
				gradient.addColorStop(1, '#075E00');
				canvasContext.fillStyle = gradient;
				canvasContext.strokeStyle = '#075E00';
				canvasContext.beginPath();
				canvasContext.arc(this.x, this.y, this.r + a, 0, 2*Math.PI);
				canvasContext.fill();
				canvasContext.stroke();
				this.n++;
				if(this.n>=120){
					this.n=0;
				}
			},
			move: function(){
				this.x = Math.floor(this.r + Math.random() * (canvasElement.width-2*this.r));
				this.y = Math.floor(this.r + Math.random() * (canvasElement.height-2*this.r));
			}
		}
		var monster = {
			x:50,
			y:60,
			r:25,
			v:1,
			n:0,
			color:'red',
			draw: function(){
				var s = 0;
				var a = 0;
				if(this.n<100){
					a=Math.floor(this.n/10);
					s=this.n/100*this.r;
				}
				else {
					a= 20 - Math.floor(this.n/10);
					s= this.r - (this.n-100)/100*this.r
				}
				var gradient = canvasContext.createLinearGradient(this.x-this.r,0, this.x+this.r,0);
				gradient.addColorStop(0, this.color);
				gradient.addColorStop(1, '#7f0000');
				canvasContext.fillStyle = gradient;
				canvasContext.strokeStyle = '#7f0000';
				canvasContext.beginPath();
				canvasContext.arc(this.x, this.y, this.r, Math.PI, 0);
				canvasContext.lineTo(this.x + this.r, this.y + this.r);
				canvasContext.bezierCurveTo(
					this.x - 0.25*this.r, this.y + this.r/2 + s, 
					this.x + 0.25*this.r, this.y + 1.5*this.r - s, 
					this.x - this.r, this.y + this.r);
				canvasContext.closePath();
				canvasContext.fill();
				canvasContext.stroke();
				canvasContext.fillStyle = 'navy';
				canvasContext.beginPath();
				canvasContext.ellipse(this.x, this.y, 15, a, 0, 0, 2*Math.PI);
				canvasContext.fill();
				canvasContext.stroke();
				this.n++;
				if(this.n>=200){
					this.n=0;
				}

			},
			move: function(){
				this.x = Math.floor(canvasElement.width/2 + Math.random() * canvasElement.width/2);
				this.y = Math.floor(canvasElement.height/2 + Math.random() * canvasElement.height/2);
			}
		}
		function loop() {
			canvasContext.clearRect(0,0, canvasElement.width, canvasElement.height);
			background();
			dot.draw();
			packMan.draw();
			monster.draw();
			if (packMan.y + packMan.vy > canvasElement.height || packMan.y + packMan.vy < 0) {
				packMan.vy = -packMan.vy;
			}
			if (packMan.x + packMan.vx > canvasElement.width || packMan.x + packMan.vx < 0) {
				packMan.vx = -packMan.vx;
			}
			packMan.x += packMan.vx;
			packMan.y += packMan.vy;
			if (Math.abs(packMan.x - dot.x) < packMan.radius + dot.r && Math.abs(packMan.y - dot.y) < packMan.radius + dot.r){
				dot.move();
				score();
			}
			chase();
			fail();
			window.requestAnimationFrame(loop);
		}
		function fail(){
			if (Math.abs(packMan.x - monster.x) < packMan.radius + monster.r && Math.abs(packMan.y - monster.y) < packMan.radius + monster.r){
				if (gameOver==true){
					return;
				}
				textElement.textContent += "\n"
				textElement.textContent += "Вы проиграли!"
				gameOver = true;
				packMan.vx = 0;
				packMan.vy = 0;
			}
		}
		function keyDown(event){
			const keyName = event.key;
			if (gameOver==true){
				return;
			}
			if(keyName==="ArrowUp"){
				packMan.dir = 1;
				packMan.vy=-packMan.v;
				packMan.vx=0;
			}
			if(keyName==="ArrowDown"){
				packMan.dir = 3;
				packMan.vy=packMan.v;
				packMan.vx=0;
			}
			if(keyName==="ArrowRight"){
				packMan.dir = 0;
				packMan.vx=packMan.v;
				packMan.vy=0;
			}
			if(keyName==="ArrowLeft"){
				packMan.dir = 2;
				packMan.vx=-packMan.v;
				packMan.vy=0;
			}
			if(keyName===" "){
				packMan.vx=0;
				packMan.vy=0;
				
			}
		}
		function chase(){
			if(monster.x > packMan.x){
				monster.x -=monster.v
			}
			if(monster.y > packMan.y){
				monster.y -=monster.v
			}
			if(monster.x < packMan.x){
				monster.x +=monster.v
			}
			if(monster.y < packMan.y){
				monster.y +=monster.v
			}
		}
		function score(){
			textElement.textContent = "Cчёт: " + gameScore;
			gameScore++;
			if(gameScore >= 15){
				monster.v = 1.25;
			}
			if(gameScore >= 30){
				monster.v = 1.5;
			}
			if(gameScore >= 45){
				monster.v = 1.75;
			}
			if(gameScore >= 60){
				monster.v = 2;
			}
		}
		function background(){
			var step = 20;
			var r = 1.5;
			canvasContext.fillStyle = '#696969';
			canvasContext.strokeStyle = '#6E6E6E';
			for(var y = step; y < canvasElement.height; y += step){
				for(var x = step; x < canvasElement.width; x += step){
					canvasContext.beginPath();
					canvasContext.arc(x, y, r, 0, 2*Math.PI);
					canvasContext.closePath();
					canvasContext.fill();
					canvasContext.stroke();
				}
			}
		}
		document.addEventListener('keydown', keyDown, false);
		dot.move();
		monster.move();	
		loop();
	</script>

</body>
</html>